<?php

class CDIEntityReceiver extends CDIAbstractTypedReceiver
  implements CDIIDInterface,
        CDILoadInterface,
        CDISaveInterface {
  
  public function __construct() {
    parent::__construct(CDI_DATA_TYPE_ENTITY);
  }
  
  public function save(CDIDataObjectInterface $object) {
    return entity_save(
        $object->getRawValue('entity_type'), 
        $object->getRawValue('object')
    );
  }
  
  public function load($id, $entity_type = NULL) {
    $object = new CDIDataObject(new CDIDataType(CDI_DATA_TYPE_ENTITY));
    $entities = entity_load($entity_type, array($id));
    $object->setRawValue('entity_type', $entity_type);
    $object->setRawValue('object', reset($entities));
    return $object;
  }
  
  public function id(CDIDataObjectInterface $object) {
    list($id,,) = entity_extract_ids(
        $object->getRawValue('entity_type'),
        $object->getRawValue('object')
    );
    return $id;
  }
  
}