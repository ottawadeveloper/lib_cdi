<?php

abstract class GenericEntityRecevier extends CDIAbstractTypedReceiver {
  
  protected $entity_type;
  protected $bundle = NULL;
  
  private $bundle_key = NULL;
  
  public function __construct($entity_type, $bundle = NULL) {
    $this->entity_type = $entity_type;
    $this->bundle = $bundle;
    $key = CDI_DATA_TYPE_ENTITY . ':' . $entity_type;
    if (!empty($bundle)) {
      $key .= ':' . $bundle;
    }
    parent::__construct($key);
  }
  
  protected function hasBundle() {
    $key = $this->getBundleKey();
    if (!empty($key)) {
      return !empty($this->bundle);
    }
    return NULL;
  }
  
  protected function entityModuleSupport($op) {
    if (!module_exists('entity')) {
      return FALSE;
    }
    return entity_type_supports($this->entity_type, $op);
  }
  
  protected function getBundleKey() {
    if ($this->bundle_key === NULL) {
      $info = entity_get_info($this->entity_type);
      if (isset($info['entity keys']['bundle'])) {
        $this->bundle_key = $info['entity keys']['bundle'];
      }
      else {
        $this->bundle_key = FALSE;
      }
    }
    return $this->bundle_key;
  }
  
  public function supportedTypes() {
    return parent::supportedTypes();
  }
  
}
